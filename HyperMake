---
format: hypermake.v0

name: ovs
description: Open vSwitch

targets:
  rebuild-toolchain:
      description: build toolchain image
      watches:
        - support/toolchain/docker/ovs
      build: support/toolchain/docker/ovs
      cache: false

  toolchain:
    description: place-holder for future dependencies

  bootstrap-ovs:
    description: Bootstraps build
    after:
      - toolchain
    watches:
      - '*.am'
      - '*.ac'
    build: support/toolchain/docker/ovs

  run-autoconf:
    description: Autoconf the Makefile
    after:
      - bootstrap-ovs
    watches:
      - '**/*.mk'
      - support/scripts/gen-makefile.sh
    cmds:
      - ./support/scripts/gen-makefile.sh

  build-ovs:
    description: build Open vSwitch source code for Ubuntu:18.04
    after:
      - run-autoconf
    watches:
      - support/scripts/build.sh
      - '**/*.c'
      - '**/*.h'
    cmds:
      - ./support/scripts/build.sh

  build:
    description: build source code
    after:
      - 'build-*'
    watches:
      - support/scripts/move-build.sh
    cmds:
      - ./support/scripts/move-build.sh

  check:
    description: perform unit test after the build
    cmds:
      - ./support/scripts/check.sh

  clean:
    description: Clean up
    always: true
    cmds:
      - ./support/scripts/clean.sh

  docker-ovs-base:
    description: build ovs base docker image
    build: ./support/docker/base/ovs
    image: 'ovs/ovs-base:1.0.0'

  docker-ovs-pre:
    description: Prepare for container build
    cmds:
      - ./support/scripts/prep-container-build.sh
    always: true

  docker-ovs:
    description: build secure docker image
    build: ./build/docker
    image: 'ovs/ovs:1.0.0'
    after:
      - docker-ovs-pre
    cmds:
      - ./support/scripts/post-container-build.sh

settings:
  default-targets:
    - build
  docker:
    image: 'ubuntu:18.04'
