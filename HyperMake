---
format: hypermake.v0

name: ovs
description: Open vSwitch

targets:
  toolchain-ubuntu:
    description: place-holder for future dependencies

  bootstrap-ubuntu-ovs:
    description: Bootstraps build
    after:
      - toolchain-ubuntu
    watches:
      - '*.am'
      - '*.ac'
    build: support/toolchain/docker/ovs-ubuntu

  run-ubuntu-autoconf:
    description: Autoconf the Makefile
    after:
      - bootstrap-ubuntu-ovs
    watches:
      - '**/*.mk'
    cmds:
      - ./support/scripts/gen-makefile.sh

  build-ubuntu-ovs:
    description: build Open vSwitch source code for Ubuntu:18.04
    after:
      - run-ubuntu-autoconf
    watches:
      - support/scripts/build.sh
      - '**/*.c'
      - '**/*.h'
    cmds:
      - ./support/scripts/build.sh

  build-ubuntu:
    description: build Open vSwitch source code for Ubuntu
    after:
      - 'build-ubuntu-*'

  check:
    description: perform unit test after the build
    cmds:
      - ./support/scripts/check.sh

  clean:
    description: Clean up
    always: true
    cmds:
      - ./support/scripts/clean.sh

  docker-ubuntu-ovs-base:
    description: build ovs base docker image
    build: ./support/docker/base/ovs-ubuntu
    image: 'ovs/ovs-ubuntu-base:1.0.0'

  docker-ubuntu-ovs-pre:
    description: Prepare for container build
    cmds:
      - ./support/scripts/prep-container-build.sh ubuntu
    always: true

  docker-ubuntu-ovs:
    description: build secure docker image
    build: ./build/docker/ubuntu
    image: 'ovs/ovs-ubuntu:1.0.0'
    after:
      - docker-ubuntu-ovs-pre
    cmds:
      - ./support/scripts/post-container-build.sh

  # hmake instructions for photon
  toolchain-photon:
    description: place-holder for future dependencies

  bootstrap-photon-ovs:
    description: Bootstraps build
    after:
      - toolchain-photon
    watches:
      - '*.am'
      - '*.ac'
    build: support/toolchain/docker/photon

  run-photon-autoconf:
    description: Autoconf the Makefile
    after:
      - bootstrap-photon-ovs
    watches:
      - '**/*.mk'
    cmds:
      - ./support/scripts/gen-makefile.sh

  debug:
    description: To build using debug flags
    after:
      - bootstrap-photon-ovs
    watches:
      - '**/*.mk'
    cmds:
      - ./support/scripts/gen-makefile.sh CFLAGS="-g"

  build-photon-ovs:
    description: build Open vSwitch source code for PhotonOS
    after:
      - run-photon-autoconf
    watches:
      - support/scripts/build.sh
      - '**/*.c'
      - '**/*.h'
    cmds:
      - ./support/scripts/build.sh

  build-photon:
    description: build Open vSwitch source code for PhotonOS
    after:
      - 'build-photon-*'

  docker-photon-ovs-pre:
    description: Prepare for container build
    cmds:
      - ./support/scripts/prep-container-build.sh photon
    always: true

  docker-photon-ovs:
    description: build secure docker image
    build: ./build/docker/photon
    after:
      - docker-photon-ovs-pre
    cmds:
      - ./support/scripts/post-container-build.sh

settings:
  default-targets:
    - build-photon
  docker:
    image: 'ovs/ovs-photon:1.0.0'
